(window.webpackJsonp=window.webpackJsonp||[]).push([[140],{1303:function(s,a,t){"use strict";t.r(a);var e=t(3),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),a("p",[s._v("主从复制是指将主数据库的DDL和DML操作通过二进制日志传到从库服务器中，然后在从库上对这些日志重新执行（也叫重做），从而使得从库和主库的数据保持同步。\nMySQL支持一台主库同时向多台从库进行复制，从库同时也可以作为其他从服务器的主库，实现链状复制。\nMySQL复制的有点主要包含以下三个方面：")]),s._v(" "),a("ol",[a("li",[s._v("主库出现问题，可以快速切换到从库提供服务。")]),s._v(" "),a("li",[s._v("实现读写分离，降低主库的访问压力。")]),s._v(" "),a("li",[s._v("可以在从库中执行备份，以避免备份期间影响主库服务。")])]),s._v(" "),a("h2",{attrs:{id:"原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[s._v("#")]),s._v(" 原理")]),s._v(" "),a("p",[s._v("MySQL的主从复制原理如下。\n在多个源的复制中，每一个复制源都会打开一个复制通道，这是一个长链接。并且每个复制源都有自己的 IO线程、一个或者多个点 SQL 线程以及 realy log。复制源接收到事务时会将其添加到relay log 中，然后通过SQL thread执行。相关官方文档如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("In MySQL multi-source replication, a replica opens multiple replication channels,\none for each replication source server. The replication channels represent the \npath of transactions flowing from a source to the replica. Each replication \nchannel has its own receiver (I/O) thread, one or more applier (SQL) threads, and\nrelay log. When transactions from a source are received by a channel's receiver \nthread, they are added to the channel's relay log file and passed through to the \nchannel's applier threads. This enables each channel to function independently.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("复制分为三步：")]),s._v(" "),a("ol",[a("li",[s._v("Master主库在事务提交时，会把数据变更记录在二进制日志文件Binlog中。")]),s._v(" "),a("li",[s._v("从库读取主库的二进制日志文件Binlog，写入到从库的中继日志Relay Log。")]),s._v(" "),a("li",[s._v("slave重做中继日志中的事件，将改变反映它自己的数据。")])]),s._v(" "),a("p",[s._v("主从复制应该是分为"),a("strong",[s._v("第一次建立连接")]),s._v("和"),a("strong",[s._v("增量数据同步")]),s._v("过程。\n"),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2023/png/20357988/1693816152967-544ea372-8bc8-4674-b834-db418c374115.png#averageHue=%23f8f7f6&clientId=uad4d9e35-9d57-4&from=paste&id=u9e871993&originHeight=324&originWidth=554&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=72992&status=done&style=none&taskId=u0ecb3ec2-9cc0-48ff-bbe3-575d3368bd7&title=",alt:"image.png"}}),s._v(" "),a("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2023/png/20357988/1693816201802-018a0c0b-1a7c-4a74-a054-3b0c66ef0455.png#averageHue=%23f2f2f2&clientId=uad4d9e35-9d57-4&from=paste&id=u4d42c029&originHeight=201&originWidth=480&originalType=url&ratio=1.25&rotation=0&showTitle=true&size=42986&status=done&style=none&taskId=u9f28dc09-11dd-46b7-a825-9c9203fb951&title=拓扑图",alt:"拓扑图"}})]),s._v(" "),a("h4",{attrs:{id:"第一次建立连接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第一次建立连接"}},[s._v("#")]),s._v(" 第一次建立连接")]),s._v(" "),a("p",[s._v("备库 B 跟主库 A 之间维持了一个长连接。主库 A 内部有一个io_thread线程，专门用于服务备库 B 的这个长连接。一个事务日志同步的完整过程是这样的：")]),s._v(" "),a("ol",[a("li",[s._v("在备库 B 上通过 change master 命令，设置主库 A 的 IP、端口、用户名、密码，以及要从哪个位置开始请求 binlog，这个位置包含文件名和日志偏移量。")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("CHANGE MASTER TO \nMASTER_HOST='192.168.56.104',\nMASTER_USER='root',\nMASTER_PASSWORD='qwer_123',\nMASTER_LOG_FILE='mysql-bin.000001',MASTER_LOG_POS=154;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("备库 B 上执行start slave命令，这时候备库会启动两个线程，就是图中的 io_thread 和 sql_thread。其中 io_thread 负责与主库建立连接。")]),s._v(" "),a("li",[s._v("主库 A 校验完用户名、密码后，开始按照备库 B 传过来的位置，从本地读取 binlog，发给备库 B。")]),s._v(" "),a("li",[s._v("备库 B 拿到 binlog 后，写到relay log（中继日志）中。")]),s._v(" "),a("li",[s._v("备库的 sql_thread 读取 relay log，解析出日志里的命令，并且回放执行。")])]),s._v(" "),a("h4",{attrs:{id:"增量同步详细流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#增量同步详细流程"}},[s._v("#")]),s._v(" 增量同步详细流程")]),s._v(" "),a("p",[s._v("详细过程如下：")]),s._v(" "),a("ol",[a("li",[s._v("客户端发起 update 请求，MySQL server 端收到请求。")]),s._v(" "),a("li",[s._v("生成被修改数据行对应的 undolog。")]),s._v(" "),a("li",[s._v("执行update成功写入内存。")]),s._v(" "),a("li",[s._v("InnboDB 生成 redo log ，此时处于 prepare阶段。")]),s._v(" "),a("li",[s._v("server 层生成binlog，事务提交时binlog做持久化，此时binlog便可以开始被同步到从库了。")]),s._v(" "),a("li",[s._v("redo log 做磁盘持久化，同时向客户端返回update的执行新结果（默认异步复制）。")]),s._v(" "),a("li",[s._v("主库发送生成的 binlog 数据。")]),s._v(" "),a("li",[s._v("从库的io_thread处理Maste传输过来的数据，保存为relay log。从库服务器会在一定时间间隔内对master二进制日志进行探测其是否发生改变，如果发生改变，则开始一个I/OThread请求master二进制事件。")]),s._v(" "),a("li",[s._v("SQL thread 读取relay log，解析并且在从库中重放执行，数据同步完成。最后I/OThread和SQLThread将进入睡眠状态，等待下一次被唤醒。")])]),s._v(" "),a("h2",{attrs:{id:"搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#搭建"}},[s._v("#")]),s._v(" 搭建")]),s._v(" "),a("h3",{attrs:{id:"主库配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主库配置"}},[s._v("#")]),s._v(" 主库配置")]),s._v(" "),a("p",[s._v("1、修改配置文件 /etc/my.cnf")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mysql服务ID，保证整个集群环境中唯一，取值范围: 1-2^32-1，默认为1")]),s._v("\nserver-id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#是否只读,1代表只读,0代表读写")]),s._v("\nread-only"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#忽略的数据,指不需要同步的数据库")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#binlog-ignore-db=mysql")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定同步的数据库")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#binlog-do-db=db01")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("2、重启MySQL服务器")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl restart mysqld\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("3、登录mysql，创建远程连接的账号，并授予主从复制权限")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#创建用户，并设置密码，该用户可在任意主机连接该MSOL服条")]),s._v("\nCREATE "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'write'")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),s._v(" IDENTIFIED WITH mysql_native_password BY "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Root@123456'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#为 'read'@'%' 用户分配主从复制权限")]),s._v("\nGRANT REPLICATION SLAVE ON *.* TO "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'write'")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("4、通过指令，查看二讲制日志坐标")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("show master status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("字段含义说明：\nfile：从哪个日志文件开始推送日志文件\nposition：从哪个位置开始推送日志\nbinlog_do_db：指定需要同步的数据库\nbinlog_ignore_db：指定不需要同步的数据库")]),s._v(" "),a("h3",{attrs:{id:"从库配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从库配置"}},[s._v("#")]),s._v(" 从库配置")]),s._v(" "),a("p",[s._v("1、修改配置文件 /etc/my.cnf")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mysql服务ID，保证整个集群环境中唯一，取值范围: 1-2^32-1，和主库不一样即可")]),s._v("\nserver-id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#是否只读,1代表只读,0代表读写")]),s._v("\nread-only"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#超级管理员只读")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#super-read-only=1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("2、重启MySQL服务器")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("systemctl restart mysqld\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("3、登录mysql，设置主库配置")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("CHANGE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REPLICATION")]),s._v(" SOURCE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" SOURCE_HOST"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx.xxx'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("SOURCE_USER"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'XXX'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("SOURCE_LOG_FILE"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("SOURCE_LOG_POS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("xxx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("上述时8.0.23中的语法，如是时mysql8.0.23之前的版本，执行如下SQL：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("CHANGE MASTER "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" MASTER_HOST"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx.xxx.xxx.xxx'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("MASTER_USER"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("MASTER_PASSWORD"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("MASTER_LOG_FILE"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xxx'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("MASTER_LOG_POS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("xxx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("4、开启同步操作")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("start replica"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 8.0.22之后")]),s._v("\nstart slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 8.0.22之前")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("5、查看主从同步状态")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("show replica status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 8.0.22之后  show replica status\\G;  # 转换成行展示")]),s._v("\nshow slave status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 8.0.22之前")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),a("p",[s._v("1.在主库上创建数据库、表，并插入数据\n2.在从库中查询数据，验证主从是否同步")]),s._v(" "),a("p",[s._v("参考资料：\n[1]. "),a("a",{attrs:{href:"https://www.bilibili.com/video/BV1jT411r77s",target:"_blank",rel:"noopener noreferrer"}},[s._v("黑马MySQL数据库进阶教程，轻松掌握mysql主从复制从原理到搭建全流程"),a("OutboundLink")],1),s._v("\n[2]. "),a("a",{attrs:{href:"https://www.dianjilingqu.com/710745.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("mysql运维——主从复制"),a("OutboundLink")],1),s._v("\n[3]. "),a("a",{attrs:{href:"https://www.cnblogs.com/shoshana-kong/p/17318124.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("主从复制实现原理详解"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=n.exports}}]);